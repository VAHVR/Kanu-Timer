<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Kanu Timer</title>

<div style="margin-top:10px; text-align:center;">
  <label style="font-weight:700;">
    <input type="checkbox" id="modeSwitch" onchange="toggleMode()">
    Online-Modus
  </label>
</div>

<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
body{margin:0;font-family:Roboto,sans-serif;background:linear-gradient(135deg, #74b9ff, #0984e3);min-height:100vh;}
.container{max-width:800px;margin:20px auto;background:#fff;min-height:calc(100vh - 40px);padding:20px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.1);}
.header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;}
.buttons{display:flex;gap:10px;}
h1{text-align:center;color:#0984e3;margin:20px 0;font-size:2.5em;text-shadow:0 2px 4px rgba(0,0,0,0.1);flex:1;}

button{min-height:50px;min-width:50px;font-size:16px;font-weight:700;border:none;border-radius:12px;cursor:pointer;transition:all 0.3s ease;}
.startBtn{background:linear-gradient(135deg, #00b894, #00cec9);color:#fff;box-shadow:0 4px 15px rgba(0,184,148,0.3);}
.startBtn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(0,184,148,0.4);}
.stopBtn{background:linear-gradient(135deg, #d63031, #e17055);color:#fff;box-shadow:0 4px 15px rgba(214,48,49,0.3);}
.stopBtn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(214,48,49,0.4);}
.resetBtn{background:linear-gradient(135deg, #b2bec3, #636e72);color:#fff;box-shadow:0 4px 15px rgba(178,190,195,0.3);}
.resetBtn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(178,190,195,0.4);}
.bauBtn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(108,92,231,0.4);}

.auswertungBtn{background:linear-gradient(135deg, #fdcb6e, #e17055);color:#fff;padding:10px 20px;border-radius:10px;font-size:14px;font-weight:700;box-shadow:0 4px 15px rgba(253,203,110,0.3);transition:all 0.3s ease;}
.auswertungBtn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(253,203,110,0.4);}

.resetAllBtn{background:linear-gradient(135deg, #d63031, #e17055);color:#fff;padding:10px 20px;border-radius:10px;font-size:14px;font-weight:700;box-shadow:0 4px 15px rgba(214,48,49,0.3);transition:all 0.3s ease;}
.resetAllBtn:hover{transform:translateY(-2px);box-shadow:0 6px 20px rgba(214,48,49,0.4);}

.tab-bar{display:flex;overflow-x:auto;border-bottom:3px solid #ddd;background:#f8f9fa;border-radius:10px 10px 0 0;padding:5px;flex-wrap:wrap;justify-content:flex-start;}
.tab-btn{padding:15px 20px;background:none;border:none;font-weight:700;color:#666;border-radius:10px;transition:all 0.3s ease;min-width:150px;flex-shrink:0;}
.tab-btn.active{color:#0984e3;border-bottom:3px solid #0984e3;background:#e3f2fd;}
.tab-btn:hover{background:#f1f1f1;}

.controls{position:sticky;top:0;background:#fff;z-index:10;display:flex;gap:10px;justify-content:center;padding:20px 0;border-bottom:2px solid #ddd;border-radius:10px;margin-bottom:20px;}

.lauf-switch{display:flex;gap:10px;margin:20px 0;}
.lauf-btn{flex:1;padding:16px;font-size:18px;background:linear-gradient(135deg, #dfe6e9, #b2bec3);color:#666;border-radius:10px;transition:all 0.3s ease;}
.lauf-btn.active{background:linear-gradient(135deg, #0984e3, #74b9ff);color:#fff;box-shadow:0 4px 15px rgba(9,132,227,0.3);}
.lauf-btn:hover{transform:translateY(-2px);}

.output{text-align:center;font-size:3em;font-weight:700;color:#0984e3;margin:25px 0;text-shadow:0 2px 4px rgba(0,0,0,0.1);background:#f8f9fa;padding:20px;border-radius:15px;border:2px solid #0984e3;}

.tor-setup{display:flex;gap:10px;align-items:center;margin-bottom:15px;padding:15px;background:#f1f2f6;border-radius:10px;}
.tor-setup.hidden{display:none;}
.tor-setup input{width:100px;font-size:18px;border:2px solid #ddd;border-radius:8px;padding:8px;}

.tor{display:grid;grid-template-columns:1fr auto auto auto;gap:8px;margin-bottom:8px;align-items:center;padding:10px;background:#fff;border-radius:10px;border:1px solid #ddd;}
.strafe-btn{min-width:50px;min-height:42px;background:linear-gradient(135deg, #dfe6e9, #b2bec3);color:#666;border-radius:8px;transition:all 0.3s ease;}
.strafe-btn.selected{background:linear-gradient(135deg, #d63031, #e17055);color:#fff;box-shadow:0 4px 15px rgba(214,48,49,0.3);}
.strafe-btn:hover{transform:translateY(-2px);}

.summary{margin-top:20px;padding:20px;background:linear-gradient(135deg, #f1f2f6, #dfe6e9);border-radius:15px;text-align:center;box-shadow:0 4px 15px rgba(0,0,0,0.1);}
.best{color:#00b894;font-weight:700;text-shadow:0 1px 2px rgba(0,184,148,0.3);}

input[type="text"]{padding:12px;font-size:16px;border:2px solid #ddd;border-radius:8px;width:100%;transition:all 0.3s ease;}
input[type="text"]:focus{border-color:#0984e3;outline:none;}

@media(max-width:600px){
 .container{margin:10px;padding:15px;}
 h1{font-size:2em;}
 .output{font-size:2.5em;}
 .summary{display:none;}
 .controls{flex-direction:column;gap:10px;}
 .lauf-switch{flex-direction:column;}
 .header{flex-direction:column;gap:10px;}
 .auswertungBtn{align-self:flex-end;}
 .resetAllBtn{align-self:flex-end;}
}
</style>
</head>

<body>
<div class="container">
  <div class="header">
    <h1>Kanu Timer</h1>
    <div class="buttons">
      <button id="auswertungBtn" class="auswertungBtn" onclick="showAuswertung()">Auswertung</button>
      <button class="resetAllBtn" onclick="resetAll()">Zurücksetzen</button>
    </div>
  </div>

  <div style="display:flex;gap:8px;margin-bottom:10px;">
    <input id="athleteName" placeholder="Sportler Name" style="flex:1;font-size:16px;">
    <button onclick="addAthlete()">+</button>
  </div>

  <div id="tabBar" class="tab-bar"></div>
  <div id="athletesContainer"></div>
</div>

<script>
let mode = localStorage.getItem("mode") || "offline";

document.addEventListener("DOMContentLoaded", () => {
  document.getElementById("modeSwitch").checked = mode === "online";
  if(mode === "online") initOnline();
});

function toggleMode(){
  mode = document.getElementById("modeSwitch").checked ? "online" : "offline";
  localStorage.setItem("mode", mode);

  if(mode === "online"){
    initOnline();
  } else {
    loadOffline();
  }
}

const firebaseConfig = {
  apiKey: "DEIN_API_KEY",
  authDomain: "DEIN_PROJEKT.firebaseapp.com",
  databaseURL: "https://DEIN_PROJEKT.firebaseio.com",
  projectId: "DEIN_PROJEKT"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.database();

let athletes = JSON.parse(localStorage.getItem('athletes')) || [];
let activeAthlete = athletes.length > 0 ? 0 : 0;

function save(){
  if(mode === "offline"){
    localStorage.setItem('athletes', JSON.stringify(athletes));
  } else {
    db.ref("athletes").set(athletes);
  }
}

function loadOffline(){
  athletes = JSON.parse(localStorage.getItem('athletes')) || [];
  render();
}

function initOnline(){
  db.ref("athletes").off(); // doppelte Listener vermeiden
  db.ref("athletes").on("value", snap => {
    athletes = snap.val() || [];
    render();
  });
}

function newRun(t){return{start:null,end:null,running:false,interval:null,strafen:new Array(t).fill(0),toreGebaut:false};}

function addAthlete(){
 if(!athleteName.value.trim())return;
 athletes.push({name:athleteName.value,activeRun:0,anzahlTore:20,runs:[newRun(20),newRun(20)]});
 athleteName.value="";activeAthlete=athletes.length-1;render();save();
}

function render(){
 tabBar.innerHTML="";athletesContainer.innerHTML="";
 athletes.forEach((a,i)=>{
  const b=document.createElement("button");
  b.className="tab-btn"+(i===activeAthlete?" active":"");
  b.textContent=a.name;b.onclick=()=>{activeAthlete=i;render();};
  tabBar.appendChild(b);
 });
 if(!athletes.length)return;

 const a=athletes[activeAthlete],r=a.runs[a.activeRun];
 const t1=timeVal(a.runs[0]),t2=timeVal(a.runs[1]);
 const best=Math.min(t1||Infinity,t2||Infinity);

 athletesContainer.innerHTML=`
 <div class="lauf-switch">
  <button class="lauf-btn ${a.activeRun===0?"active":""}" onclick="switchRun(0)">Lauf 1</button>
  <button class="lauf-btn ${a.activeRun===1?"active":""}" onclick="switchRun(1)">Lauf 2</button>
 </div>

 <div class="controls">
  <button class="startBtn" onclick="start()">Start</button>
  <button class="stopBtn" onclick="stop()">Ziel</button>
  <button class="resetBtn" onclick="reset()">Reset</button>
 </div>

 <div class="output" id="time">${calcTime(r)}</div>

 <div class="tor-setup ${r.toreGebaut?"hidden":""}">
  <strong>Anzahl Tore:</strong>
  <input id="anzTore" type="number" value="${a.anzahlTore}" min="1" max="30">
  <button class="bauBtn" onclick="bauTore()">OK</button>
 </div>

 <div id="torContainer" style="display:${r.toreGebaut?"block":"none"}"></div>

 <div class="summary">
  <div class="${t1===best&&best!==Infinity?"best":""}">Lauf 1: ${calcTime(a.runs[0])}</div>
  <div class="${t2===best&&best!==Infinity?"best":""}">Lauf 2: ${calcTime(a.runs[1])}</div>
 </div>`;
 if(r.toreGebaut)renderTore();
}

function switchRun(r){athletes[activeAthlete].activeRun=r;render();save();}

function start(){
 const r = athletes[activeAthlete].runs[athletes[activeAthlete].activeRun];
 if(r.running || r.end) return;

 r.start = mode === "online"
   ? firebase.database.ServerValue.TIMESTAMP
   : Date.now();

 r.running = true;
 r.interval = setInterval(update, 50);
 save();
}

function stop(){
 const r = athletes[activeAthlete].runs[athletes[activeAthlete].activeRun];
 if(!r.running) return;

 clearInterval(r.interval);
 r.running = false;

 r.end = mode === "online"
   ? firebase.database.ServerValue.TIMESTAMP
   : Date.now();

 render();
 save();
}

function reset(){
 const a=athletes[activeAthlete];
 a.runs[a.activeRun]=newRun(a.anzahlTore);render();save();
}

function update(){
 document.getElementById("time").innerText=
 calcTime(athletes[activeAthlete].runs[athletes[activeAthlete].activeRun]);
}

function timeVal(r){
 if(!r.start||!r.end)return null;
 return ((r.end-r.start)/1000)+r.strafen.reduce((a,b)=>a+b,0);
}

function calcTime(r){
 if(!r.start)return"-";
 const base=((r.running?Date.now():r.end)-r.start)/1000;
 return (base+r.strafen.reduce((a,b)=>a+b,0)).toFixed(2)+" s";
}

function bauTore(){
 const a=athletes[activeAthlete],r=a.runs[a.activeRun];
 a.anzahlTore=+anzTore.value;
 r.strafen=new Array(a.anzahlTore).fill(0);
 r.toreGebaut=true;render();save();
}

function renderTore(){
 const r=athletes[activeAthlete].runs[athletes[activeAthlete].activeRun];
 torContainer.innerHTML="";
 r.strafen.forEach((v,i)=>{
  torContainer.innerHTML+=`
  <div class="tor">
   <strong>Tor ${i+1}</strong>
   <button class="strafe-btn ${v===50?"selected":""}" onclick="setStrafe(${i},50)">50</button>
   <button class="strafe-btn ${v===2?"selected":""}" onclick="setStrafe(${i},2)">2</button>
   <button class="strafe-btn ${v===0?"selected":""}" onclick="setStrafe(${i},0)">/</button>
  </div>`;
 });
}

function setStrafe(i,v){
 athletes[activeAthlete].runs[athletes[activeAthlete].activeRun].strafen[i]=v;
 render();save();
}

function resetAll(){
 if(confirm('Alle Daten zurücksetzen? Dies löscht alle Sportler und Zeiten.')){
  athletes = [];
  localStorage.removeItem('athletes');
  activeAthlete = 0;
  render();
 }
}

function showAuswertung(){
 let maxTore = Math.max(...athletes.map(a => a.anzahlTore));
 let labels = Array.from({length: maxTore}, (_, i) => `Tor ${i+1}`);
 let data2 = Array(maxTore).fill(0);
 let data50 = Array(maxTore).fill(0);
 athletes.forEach(a => {
  a.runs.forEach(run => {
   run.strafen.forEach((strafe, i) => {
    if (i < maxTore) {
     if (strafe === 2) data2[i] += strafe;
     else if (strafe === 50) data50[i] += strafe;
    }
   });
  });
 });
 let datasets = [{
  label: '2-Sekunden-Strafen',
  data: data2,
  backgroundColor: 'rgba(255, 193, 7, 0.8)',
  borderColor: 'rgba(255, 193, 7, 1)',
  borderWidth: 1
 }, {
  label: '50-Sekunden-Strafen',
  data: data50,
  backgroundColor: 'rgba(220, 53, 69, 0.8)',
  borderColor: 'rgba(220, 53, 69, 1)',
  borderWidth: 1
 }];

 // Rangliste berechnen
 let results = athletes.map(a => {
  let t1 = timeVal(a.runs[0]);
  let t2 = timeVal(a.runs[1]);
  let bestTime = Math.min(t1 || Infinity, t2 || Infinity);
  return {name: a.name, bestTime};
 }).filter(r => r.bestTime !== Infinity).sort((a,b) => a.bestTime - b.bestTime);

 let html = `
  <html>
  <head>
  <title>Auswertung - Kanu Timer</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"><\/script>
  <style>
   body{font-family:Roboto,sans-serif;background:linear-gradient(135deg, #74b9ff, #0984e3);margin:0;padding:20px;}
   .container{max-width:1200px;margin:auto;background:#fff;padding:20px;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.1);}
   h1{text-align:center;color:#0984e3;}
   h2{text-align:center;color:#0984e3;margin:30px 0 10px 0;font-size:1.5em;}
   table{width:100%;border-collapse:collapse;margin-top:20px;}
   th,td{border:1px solid #ddd;padding:10px;text-align:center;}
   th{background:#0984e3;color:#fff;}
   .best{background:#00b894;color:#fff;}
   .tor-strafen{display:flex;gap:5px;flex-wrap:wrap;}
   .strafe{display:inline-block;padding:2px 5px;background:#dfe6e9;border-radius:5px;margin:1px;}
   .strafe[data-val="50"]{background:#d63031;color:#fff;}
   .strafe[data-val="2"]{background:#e17055;color:#fff;}
   canvas{margin-top:40px;}
  </style>
  </head>
  <body>
  <div class="container">
  <h1>Kanu Timer - Auswertung</h1>`;
 
 if(results.length > 0){
  let firstTime = results[0].bestTime;
  html += `
  <h2>Rangliste</h2>
  <table>
   <tr><th>Rang</th><th>Sportler</th><th>Beste Zeit</th><th>Abstand (s)</th><th>Abstand (%)</th></tr>`;
  results.forEach((r, i) => {
   let diffSec = (r.bestTime - firstTime).toFixed(2);
   let diffPerc = firstTime > 0 ? ((r.bestTime - firstTime) / firstTime * 100).toFixed(2) : '0.00';
   html += `<tr><td>${i+1}</td><td>${r.name}</td><td>${r.bestTime.toFixed(2)} s</td><td>${diffSec} s</td><td>${diffPerc} %</td></tr>`;
  });
  html += `</table>`;
 }
 
 html += `<hr style="margin: 40px 0; border: none; border-top: 2px solid #ddd;">`;
 
 html += `
  <h2>Einzelauswertung</h2>
  <table>
   <tr><th>Sportler</th><th>Lauf 1 Zeit</th><th>Lauf 1 Strafen pro Tor</th><th>Lauf 2 Zeit</th><th>Lauf 2 Strafen pro Tor</th></tr>`;
 
 athletes.forEach(a => {
  const t1 = calcTime(a.runs[0]);
  const t2 = calcTime(a.runs[1]);
  const strafen1 = a.runs[0].strafen.map((s,i) => `<span class="strafe" data-val="${s}">Tor ${i+1}: ${s}s</span>`).join('');
  const strafen2 = a.runs[1].strafen.map((s,i) => `<span class="strafe" data-val="${s}">Tor ${i+1}: ${s}s</span>`).join('');
  html += `<tr><td>${a.name}</td><td>${t1}</td><td class="tor-strafen">${strafen1}</td><td>${t2}</td><td class="tor-strafen">${strafen2}</td></tr>`;
 });
 
 html += `
  </table>
  
  <hr style="margin: 40px 0; border: none; border-top: 2px solid #ddd;">
  
  <h2>Analyse der Strafsekunden pro Tor</h2>
  <canvas id="strafeChart" width="400" height="200"></canvas>
  </div>
  <script>
   const ctx = document.getElementById('strafeChart').getContext('2d');
   const chart = new Chart(ctx, {
    type: 'bar',
    data: {
     labels: ${JSON.stringify(labels)},
     datasets: ${JSON.stringify(datasets)}
    },
    options: {
     responsive: true,
     plugins: {
      legend: {
       position: 'top',
      },
      title: {
       display: true,
       text: 'Gesamt Strafsekunden pro Tor (über alle Sportler und Läufe)'
      }
     },
     scales: {
      x: {
       stacked: true,
       title: {
        display: true,
        text: 'Tor'
       }
      },
      y: {
       stacked: true,
       beginAtZero: true,
       title: {
        display: true,
        text: 'Strafsekunden'
       }
      }
     }
    }
   });
  <\/script>
  </body>
  </html>`;
 
 const win = window.open('', '_blank');
 win.document.write(html);
 win.document.close();
}

render();
</script>
<footer style="text-align: center; margin-top: 20px; font-size: 0.9em; color: #555;">
  Made by Vinzent
</footer>
</body>
</html>
